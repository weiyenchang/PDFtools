<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"> 
  <title data-i18n="pageTitle">學習計劃表</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Chiron+GoRound+TC:wght@200..900&family=Chocolate+Classical+Sans&family=Noto+Sans+TC:wght@100..900&display=swap');
    /* CSS Variables for Theme */
    :root {
      /* Light Mode */
      --bg-body: #F3F1F5;
      --bg-primary: #fff; /* Input/Day background */
      --bg-secondary: #eee; /* Button background */
      --text-color: #3B3E3D;
      --border-color: #ccc;
      --button-hover: #ddd;
    }
    .dark-mode {
      /* Dark Mode */
      --bg-body: #1E1E1E;
      --bg-primary: #2D2D30;
      --bg-secondary: #3C3C3F;
      --text-color: #f7f7f7;
      --border-color: #555;
      --button-hover: #4a4a4d;
    }

    body {
      font-family: "Noto Sans TC", sans-serif;
      padding: 20px;
      margin: 0;
      background-color: var(--bg-body); /* Using Variable */
      color: var(--text-color); /* Using Variable */
    }
    h1 {
      font-size: 30px;
      letter-spacing: 2px;
    }
    .container {
      display: flex;
      gap: 20px;
    }
    .sidebar {
      flex: 1;
      max-width: 300px;
    }
    .main {
      flex: 3;
    }
    label {
      display: block;
      margin: 8px 0 4px;
    }
    /* 統一設定所有輸入欄位的基礎樣式 */
    input[type="text"], input[type="number"], input[type="date"], textarea, button {
      padding: 6px;
      margin-bottom: 12px;
      border: 1px solid var(--border-color); /* Using Variable */
      border-radius: 4px;
      font-size: 14px;
      background-color: var(--bg-primary); /* Using Variable */
      color: var(--text-color); /* Using Variable */
      /* 確保按鈕內容文字與圖標之間的間距 */
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px; /* 圖標與文字間距 */
    }
    /* 確保寬度一致 */
    input[type="text"], input[type="date"], input[type="number"], textarea {
      width: 261px;
      box-sizing: border-box; /* Add box-sizing to manage padding/border within width */
    }
    /* 讓 textarea 的高度保持彈性，但給一個合理的最小高度 */
    textarea {
      min-height: 50px; 
    }
    /* 專門針對 Textarea 的高度調整 */
    #plan-container textarea:not(#outline) {
        height: 80px; /* 設定新的日期 textarea 高度 */
    }
    #outline {
        height: 209px; /* 維持大綱 textarea 的高度 */
    }

    button {
      background-color: var(--bg-secondary); /* Using Variable */
      cursor: pointer;
    }
    button:hover {
      background-color: var(--button-hover); /* Using Variable */
    }

    /* === 月曆顯示樣式調整 START === */
    #calendar {
      margin-top: 20px;
      display: flex; /* Use flex to stack month views vertically */
      flex-direction: column;
      gap: 20px; /* Gap between different months */
    }
    .month-container {
        border: 1px solid var(--border-color);
        padding: 15px;
        border-radius: 6px;
        background-color: var(--bg-primary); /* Use primary color as month background */
    }
    
    /* 1. Month Header Style for Collapse */
    .month-header {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 10px;
        padding-bottom: 5px;
        border-bottom: 2px solid var(--border-color);
        text-align: left; /* Aligned left for the collapse icon */
    }
    .month-header > div { /* targeting the flex wrapper inside month-header for the click area */
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        cursor: pointer;
        width: 100%;
        padding: 0 5px; 
    }
    .month-header .toggle-icon {
        font-size: 20px;
        /* 移除 transform 相關設定，改為切換文字 */
        margin-left: 10px;
    }
    
    /* 2. Month Content Collapse */
    .month-content-wrapper {
        overflow: hidden;
        max-height: 2000px; /* A large value for expansion */
        transition: max-height 0.3s ease-out;
    }
    .month-content-wrapper.collapsed {
        max-height: 0;
        margin-top: 0;
        margin-bottom: 0;
        padding-top: 0;
        padding-bottom: 0;
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
    }
    .weekday-header {
        font-weight: bold;
        text-align: center;
        padding: 5px 0;
    }
    .day {
        border: 1px solid var(--border-color);
        background-color: var(--bg-primary); 
        padding: 5px; /* Slightly smaller padding for denser view */
        min-height: 80px; /* Minimum height for calendar cells */
        white-space: pre-wrap;
        border-radius: 4px; 
        overflow: hidden; /* Ensure content fits */
    }
    .empty-day {
        background-color: transparent;
        border: 1px dashed var(--border-color); /* Dashed border for empty days */
        min-height: 80px;
        border-radius: 4px;
        /* Day number not displayed in empty-day */
    }
    .day-label { /* Adjusted from .date-label for consistency */
        font-weight: bold;
        margin-bottom: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .day-label span {
        font-weight: bold;
    }
    .task {
        font-size: 12px;
        padding: 1px 3px;
        margin-top: 2px;
        border-radius: 2px;
        line-height: 1.3;
    }
    /* === 月曆顯示樣式調整 END === */
    
    /* Calendar Checkbox Style */
    .day-checkbox {
      width: 15px !important;
      height: 15px;
      margin: 0 !important;
      padding: 0 !important;
      cursor: pointer;
      display: block !important;
    }
    .plan-group {
      border: 1px solid var(--border-color); /* Using Variable */
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 6px;
    }
    .plan-header {
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .plan-header h3 {
      margin: 0;
    }
    .plan-header .toggle-icon {
      font-size: 20px;
      /* 移除 transform 相關設定，改為切換文字 */
    }
    /* .plan-header .toggle-icon.rotated {
      transform: rotate(180deg);
    } */
    .plan-header .delete-btn {
      margin-left: 10px;
      padding: 3px 8px;
      font-size: 12px;
      background-color: #f44336;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    .delete-btn{
      margin:0;
    }
    .plan-header .delete-btn:hover {
      background-color: #d32f2f;
    }
    /* --- FIX: Collapse Functionality CSS --- */
    .plan-content {
      overflow: hidden;
      max-height: 1000px; /* A large value for expansion */
      transition: max-height 0.3s ease-out;
    }
    .plan-content.collapsed {
      max-height: 0;
      padding-top: 0; /* FIX: Ensure padding is zero when collapsed */
      padding-bottom: 0; /* FIX: Ensure padding is zero when collapsed */
    }
    /* --- END FIX --- */
    .color-label {
        display: flex;
        align-items: center;
    }
    .color-label input[type="color"] {
        width: 30px;
        height: 30px;
        padding: 2px;
        margin-left: 8px;
        cursor: pointer;
        border: 1px solid var(--border-color); /* Using Variable */
    }
    .weekday-checkboxes {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 12px;
    }
    .weekday-checkboxes label {
      display: inline-flex;
      align-items: center;
      margin: 0;
    }
    .btn-group{
      display: flex;
    }
    .color-label button {
        margin-bottom: 0; /* Adjust button margin inside color label */
    }
    
    /* RWD media query for small screens */
    @media (max-width: 768px) {
      .container {
        flex-direction: column;
      }
      .sidebar, .main {
        flex: 1;
        max-width: 100%;
      }
      .calendar-grid { /* RWD for calendar */
        grid-template-columns: repeat(7, 1fr);
      }
      /* 讓輸入欄位在小螢幕上佔滿寬度 */
      input[type="text"], input[type="date"], input[type="number"], textarea, button {
        width: 100%;
        box-sizing: border-box; /* 確保 padding 不會讓寬度超出 100% */
      }
      /* 修正 RWD 寬度覆蓋，讓非輸入欄位按鈕恢復自動寬度 */
      #lang-toggle-btn, #theme-toggle-btn, [onclick="addPlan()"], [onclick="generatePlan()"], [onclick="downloadCSV()"], #addToCalendarBtn {
          width: auto;
          display: inline-flex; /* 恢復為內容決定寬度的 inline-flex */
      }
      .sidebar button {
        margin-right: 5px; /* 增加按鈕間距 */
      }
      .sidebar label { /* 確保 sidebar 內的 label (全選日期) 在 RWD 下也是 100% 寬度 */
        width: 100%;
      }
    }
    .header{
      display: flex;
      align-items: center;
      width: 100%;
    }
    .header p{
      margin-left:10px;
      margin-right:10px;
      font-size: 30px;
    }
    .title{
      flex: 1;
      display: flex;
      align-items: center;
    }
    .header_btn{
      flex: 1;
      display: flex;
      justify-content:flex-end;
    }
    .header_btn button{
      /* 圖標字體樣式 */
      border-radius: 50px;
      padding: 10px;
      margin:10px !important;
      font-size: 15px;
      background-color: white;
      border: none;
      color:#3B3E3D;
      
      /* 取消原本 button 的 flex 居中，讓內容靠左/右 */
      justify-content: start; 
    }
    /* 確保在 Dark Mode 下按鈕顏色維持一致 */
    .dark-mode .header_btn button {
        background-color: #3C3C3F; 
        color: #f7f7f7; 
        border: 1px solid #555;
    }
    .titleLabel{
      display: none;
    }
    label span{
      font-weight: 300;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="title">
      <p><i class="fa-regular fa-calendar-days"></i></p>
      <h1 data-i18n="mainHeader">記憶計劃表</h1>
    </div>
    <div class="header_btn">
      <button onclick="toggleLanguage()" id="lang-toggle-btn">
        <i class="fa-solid fa-language"></i>
      </button>
      <button onclick="toggleTheme()" id="theme-toggle-btn">
        <i id="theme-icon" class="fa-solid fa-moon"></i>
        <span data-i18n-id="toggleThemeBtn">夜間</span>
      </button>
    </div>
  </div>
  <div class="container">
    <div class="sidebar">
      <div id="plan-container">
        </div>
      <div style="display:flex;">
        <button style="margin-right: 5px;" onclick="addPlan()" data-i18n="addPlanBtn">新增學習計劃</button>
        <button onclick="generatePlan()" data-i18n="generatePlanBtn">產生記憶計劃</button>
      </div>
      <hr>
      <div id="gc-title-setting" style="border: 1px solid var(--border-color); padding: 10px; margin-bottom: 12px; border-radius: 4px;">
        <label style="font-weight: bold; margin-bottom: 4px;" data-i18n-id="gcTitleSettingLabel">Google Caledar 標題顯示設定:</label>
        <div>
          <input type="radio" id="mergePlans" name="gcTitleOption" value="merge" checked>
          <label for="mergePlans" style="display: inline;" data-i18n-id="mergePlansLabel">合併多個計劃</label>
        </div>
        <div>
          <input type="radio" id="separatePlans" name="gcTitleOption" value="separate">
          <label for="separatePlans" style="display: inline;" data-i18n-id="separatePlansLabel">將各計劃獨立顯示</label>
        </div>
      </div>
      <button onclick="addToGoogleCalendar()" id="addToCalendarBtn">
        <i class="fa-brands fa-google"></i>
        <span data-i18n-id="addToCalendarBtnText">加入 Google 行事曆</span>
      </button>
      <button onclick="downloadCSV()" data-i18n="downloadCSVBtn">
        下載 Google Caledar Import csv</button>
    </div>
    <div class="main">
      <label style="margin: 0 0 12px 0; display: flex; align-items: center; width: 100%; box-sizing: border-box;">
        <input type="checkbox" id="selectAllDays" onchange="toggleAllCheckboxes()" style="width: auto; margin: 0 5px 0 0;">
        <span data-i18n-id="selectAllDays">全選日期</span>
      </label>

      <div id="calendar"></div>
    </div>
  </div>

  <script>
    const weekdayMap = ['日', '一', '二', '三', '四', '五', '六'];
    const weekdayMap_en = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const randomPalette = ['#63b598', '#ce7d78', '#ea9e70', '#a48a9e', '#c68487', '#8e967a', '#7895aa', '#e1a692', '#8676a3', '#8e8582', '#9f85c0', '#a29587', '#5d9185', '#b08c9f', '#c99a6b', '#c4c481', '#7889b7', '#a19777', '#c29790', '#83afaf', '#9c9297', '#92a3b7', '#b9745e', '#a0b189', '#9f7887'];
    const defaultColors = ['#FBEAE4', '#FEF3EB', '#FCF1D9', '#E5EEE4', '#FFFFFF', '#E9E7EE'];
    let latestPlan = {};
    let planCount = 0;
    let planColors = {}; 
    let currentLang = 'zh'; // 預設語言

    // 國際化文本
    const translations = {
      zh: {
        pageTitle: '學習計劃表',
        mainHeader: '學習計劃表',
        toggleThemeBtn: '夜間模式',
        toggleLangBtn: '切換語言',
        addPlanBtn: '新增計劃',
        generatePlanBtn: '產生計劃',
        downloadCSVBtn: '下載 Google Caledar Import CSV',
        selectAllDays: '全選日期', 
        addToCalendarBtnText: '加入 Google 行事曆', 
        
        // NEW Calendar Settings
        gcTitleSettingLabel: 'Google Caledar 標題顯示設定:', 
        mergePlansLabel: '合併顯示多個計劃',
        separatePlansLabel: '將計劃各自獨立顯示',

        planHeader: '',
        titleLabel: '計劃名稱：',
        colorLabel: '標籤顏色：',
        randomColorBtn: '隨機',
        unitLabel: '任務內容：',
        startDateLabel: '開始日期：',
        endDateLabel: '結束日期（可留空）：',
        executionDatesLabel: '指定執行日期：',
        executionDatesPlaceholder: '用逗號或換行分隔 M/D 或 YYYY/M/D',
        excludeDaysLabel: '排除日：',
        weekdaySun: '週日', weekdayMon: '週一', weekdayTue: '週二', weekdayWed: '週三', weekdayThu: '週四', weekdayFri: '週五', weekdaySat: '週六',
        excludeDatesLabel: '指定排除日：',
        excludeDatesPlaceholder: '用逗號或換行分隔 M/D 或 YYYY/M/D',
        rangeLabel: '任務範圍：',
        rangeTypePages: '頁數',
        rangeTypeOutline: '任務清單/大綱',
        pageRangeLabel: '頁數範圍（ex. 19~306）：',
        outlineLabel: '任務清單/大綱：',
        outlinePlaceholder: '用逗號分隔，例如：主題一,主題二,主題三',
        dailyAmountLabel: '執行量/次：',
        reverseOrder: '逆序',
        showContentLabel: '執行動作：',
        showStudy: '學習',
        showReview: '複習',
        showCustom: '自訂', 
        customTextLabel: '自訂文字：', 
        customTextPlaceholder: '例如：今日任務', 
        deleteBtn: '刪除',
        studyText: '學習',
        reviewText: '複習',
        // 舊的 CSV 標頭已移除
      },
      en: {
        pageTitle: 'Ebbinghaus Memory Plan',
        mainHeader: 'Ebbinghaus Memory Plan',
        toggleThemeBtn: 'Dark',
        toggleLangBtn: 'Toggle Language',
        addPlanBtn: 'Add Learning Plan',
        generatePlanBtn: 'Generate Memory Plan',
        downloadCSVBtn: 'Download Google Calendar Import CSV',
        selectAllDays: 'Select All Days', 
        addToCalendarBtnText: 'Add to Google Calendar', 
        
        // NEW Calendar Settings
        gcTitleSettingLabel: 'Google Calendar Title Setting:',
        mergePlansLabel: 'Merge Multiple Plans',
        separatePlansLabel: 'Show Each Plan Separately',

        planHeader: '',
        titleLabel: 'Plan Name:',
        colorLabel: 'Plan Color:',
        randomColorBtn: 'Random Color',
        unitLabel: 'Unit:',
        startDateLabel: 'Start Date:',
        endDateLabel: 'End Date (Optional):',
        executionDatesLabel: 'Specified Execution Dates (M/D or YYYY/M/D comma/newline separated):',
        executionDatesPlaceholder: 'e.g. 11/23\n11/25\n2026/1/1',
        excludeDaysLabel: 'Exclude Days:',
        weekdaySun: 'Sun', weekdayMon: 'Mon', weekdayTue: 'Tue', weekdayWed: 'Wed', weekdayThu: 'Thu', weekdayFri: 'Fri', weekdaySat: 'Sat',
        excludeDatesLabel: 'Exclude Dates (M/D or YYYY/M/D comma/newline separated):',
        excludeDatesPlaceholder: 'e.g. 7/22\n8/23\n2025-12-25',
        rangeLabel: 'Learning Scope:',
        rangeTypePages: 'Page Range',
        rangeTypeOutline: 'Outline',
        pageRangeLabel: 'Page Range (e.g. 19~306):',
        outlineLabel: 'Outline (comma separated):',
        outlinePlaceholder: 'e.g. Topic 1, Topic 2, Topic 3',
        dailyAmountLabel: 'Daily Amount:',
        reverseOrder: 'Reverse Order',
        showContentLabel: 'Show Content:',
        showStudy: 'Study',
        showReview: 'Review',
        showCustom: 'Custom', 
        customTextLabel: 'Custom Text:', 
        customTextPlaceholder: 'e.g. Today\'s Task', 
        deleteBtn: 'Delete',
        studyText: 'Study',
        reviewText: 'Review',
        // 舊的 CSV 標頭已移除
      }
    };

    function parsePageRange(rangeStr) {
      const [start, end] = rangeStr.split("~").map(x => parseInt(x));
      return { start, end };
    }

    function formatDate(date) {
      const m = date.getMonth() + 1;
      const d = date.getDate();
      return `${m}/${d}`;
    }

    /**
     * @description 使用本地時間 component 來格式化 YYYY-MM-DD，避免 toISOString 的時區偏移問題。
     */
    function getDateStr(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
    
    /**
     * @description 修正後的日期解析函數，可解析 M/D, YYYY/M/D, YYYY-M-D 等多種日期格式。
     */
    function parseDateInputToYYYYMMDD(dateString, referenceYear) {
        if (!dateString) return null;
        // 1. 標準化分隔符（將 - 替換為 /）並分割
        const parts = dateString.trim().replace(/-/g, '/').split('/').map(s => s.trim()).filter(Boolean);
        
        let year, month, day;

        if (parts.length === 3) {
            // YYYY/M/D 格式 (例如: 2026/01/01)
            const part1 = Number(parts[0]);
            const part2 = Number(parts[1]);
            const part3 = Number(parts[2]);
            
            if (part1 >= 1000) { 
                year = part1;
                month = part2;
                day = part3;
            } else if (part3 >= 1000) { 
                // M/D/YYYY 格式 (例如: 1/1/2026)
                year = part3;
                month = part1;
                day = part2;
            } else {
                return null; // 無效的完整日期
            }

        } else if (parts.length === 2) {
            // M/D 格式 (例如: 11/23)。使用 referenceYear。
            year = referenceYear;
            month = Number(parts[0]);
            day = Number(parts[1]);
        } else {
            return null; // 無效的格式
        }

        if (isNaN(year) || isNaN(month) || isNaN(day) || month < 1 || month > 12 || day < 1 || day > 31) return null;

        // 關鍵修正：使用 (year, month - 1, day) 來創建 Date 物件，避免時區問題導致日期錯誤
        const date = new Date(year, month - 1, day);

        // 驗證日期是否有效（例如 2/30 會被 JS 自動調整）
        if (date.getFullYear() === year && date.getMonth() === month - 1 && date.getDate() === day) {
            return getDateStr(date); // 返回 YYYY-MM-DD (使用已修復的 getDateStr)
        }
        return null;
    }
    
    /**
     * @description 僅返回學習範圍字串，不包含學習內容（Unit Name）。
     */
    function getRangeString(items) { 
      if (items.length === 0) return "";
      const isNumberRange = !isNaN(Number(items[0]));

      if (isNumberRange) {
        if (items.length === 1) return `${items[0]}`;
        return `${items[0]}~${items[items.length - 1]}`;
      } else {
        const separator = currentLang === 'zh' ? '、' : ', ';
        return `${items.join(separator)}`;
      }
    }
    
    /**
     * @description Schedules review tasks for a set of study items.
     */
    function scheduleReviews(studyDate, studyItems, allPlans, id, reviewPrefix, showReview, excludeWeekdays, excludeDates) { 
        if (!showReview) return;

        // Review offsets: 1 day, 3 days, 6 days, 14 days
        [1, 3, 6, 14].forEach(offset => {
            // Create a safe date object for calculation (Study Date is already a safe Date object)
            const reviewDate = new Date(studyDate); 
            reviewDate.setDate(reviewDate.getDate() + offset);
            
            let rDateStr = getDateStr(reviewDate);
            let rDateKey = formatDate(reviewDate); // M/D format for exclusion check

            // Advance date if it falls on an excluded day/date
            while (excludeWeekdays.includes(reviewDate.getDay()) || excludeDates.includes(rDateKey)) {
                reviewDate.setDate(reviewDate.getDate() + 1);
                rDateStr = getDateStr(reviewDate);
                rDateKey = formatDate(reviewDate);
            }

            if (!allPlans[rDateStr]) allPlans[rDateStr] = [];
            const reviewTask = `${reviewPrefix} ${getRangeString(studyItems)}`; 
            
            // Avoid duplicate review tasks
            const existingTask = allPlans[rDateStr].find(t => t.text === reviewTask);
            if (!existingTask) {
                allPlans[rDateStr].push({text: reviewTask, planId: id});
            }
        });
    }

    function generatePlan() {
      const allPlans = {};
      const planGroups = document.querySelectorAll('.plan-group');
      
      planColors = {};
      planGroups.forEach(group => {
        const id = group.dataset.id;
        planColors[id] = document.getElementById(`colorPicker-${id}`).value;
      });

      const studyText = translations[currentLang].studyText;
      const reviewText = translations[currentLang].reviewText;

      planGroups.forEach(group => {
        const id = group.dataset.id;
        const unit = document.getElementById(`unit-${id}`).value; // 學習內容（Unit Name）
        const startDateValue = document.getElementById(`startDate-${id}`).value; // YYYY-MM-DD or empty
        const dailyAmount = parseInt(document.getElementById(`dailyAmount-${id}`).value);

        // --- Determine Reference Year and Specified Execution Dates ---
        
        const executionDatesInput = document.getElementById(`executionDates-${id}`).value.trim();
        let specifiedDates = [];
        
        // 1. Determine the year reference (use startDate's year, or current year if startDate is empty)
        let referenceYear = new Date().getFullYear();
        if (startDateValue) {
             // 確保能正確從 YYYY-MM-DD 取得年份
             referenceYear = new Date(startDateValue.split('-')[0], 0, 1).getFullYear();
        }

        // 2. Parse specifiedDates (Handle commas and newlines)
        if (executionDatesInput) {
            const rawDates = executionDatesInput.split(/[\n,]/)
                .map(s => s.trim())
                .filter(Boolean); // 過濾掉空字串
                
            specifiedDates = rawDates
                .map(s => parseDateInputToYYYYMMDD(s, referenceYear)) // 使用新的解析函數
                .filter(Boolean) 
                .sort(); // 排序日期
        }

        // 3. Validation Check (Adjusted for specifiedDates)
        // Check 1: Must have a scheduling mechanism (Start Date or Execution Dates)
        if (!startDateValue && specifiedDates.length === 0) {
            console.warn(`學習計劃 #${id} 已跳過：缺少「開始日期」或「指定執行日期」。`);
            return; 
        }
        // Check 2: Daily amount must be valid
        if (isNaN(dailyAmount) || dailyAmount <= 0) {
            console.warn(`學習計劃 #${id} 已跳過：無效的「每天學習量」。`);
            return; 
        }
        
        // --- Get other parameters ---
        const reverse = document.getElementById(`reverseOrder-${id}`).checked;
        const rangeType = document.querySelector(`input[name="rangeType-${id}"]:checked`).value;
        
        const showStudy = document.getElementById(`showStudy-${id}`).checked;
        const showReview = document.getElementById(`showReview-${id}`).checked;
        const showCustom = document.getElementById(`showCustom-${id}`).checked;
        const customText = document.getElementById(`customText-${id}`).value.trim();
        
        // 決定任務前綴 (Prefix)
        let studyPrefix = studyText;
        let reviewPrefix = reviewText;

        if (showCustom && customText) {
            studyPrefix = customText;
            reviewPrefix = customText;
        }

        // Fix #1: 決定是否要產生主要任務 (Study Task / Custom Task)
        const shouldGeneratePrimaryTask = showStudy || (showCustom && customText.length > 0);

        let excludeWeekdays = [];
        for (let i = 0; i < 7; i++) {
          if (document.getElementById(`excludeWeekday-${id}-${i}`).checked) {
            excludeWeekdays.push(i);
          }
        }
        
        // 4. Parse Exclude Dates (Handle commas and newlines)
        const excludeDatesInput = document.getElementById(`excludeDates-${id}`).value.trim();
        const rawExcludeDates = excludeDatesInput.split(/[\n,]/)
            .map(s => s.trim())
            .filter(Boolean);
            
        // Exclude Dates for comparison (M/D format)
        const excludeDates = rawExcludeDates
            .map(s => {
                 const fullDateStr = parseDateInputToYYYYMMDD(s, referenceYear);
                 if (fullDateStr) {
                     const dateParts = fullDateStr.split('-');
                     // 使用本地時間建構函數，確保日期在本地時間是正確的
                     const dateObj = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));
                     return formatDate(dateObj); // Returns M/D
                 }
                 return null;
            })
            .filter(Boolean); // M/D format array

        let learningItems = [];

        if (rangeType === 'pages') {
          const { start: pageStart, end: pageEnd } = parsePageRange(document.getElementById(`pageRange-${id}`).value);
          if (reverse) {
            for (let i = pageEnd; i >= pageStart; i--) learningItems.push(i);
          } else {
            for (let i = pageStart; i <= pageEnd; i++) learningItems.push(i);
          }
        } else {
          const outlineText = document.getElementById(`outline-${id}`).value;
          learningItems = outlineText.split(',').map(s => s.trim()).filter(Boolean);
          if (reverse) {
            learningItems.reverse();
          }
        }

        let index = 0;
        
        // --- Core Scheduling Logic ---

        if (specifiedDates.length > 0) {
            // Case 1: Specified Execution Dates are provided (Study tasks only run on these dates)
            
            for (let i = 0; i < specifiedDates.length && index < learningItems.length; i++) {
                const dateStr = specifiedDates[i]; // YYYY-MM-DD
                
                // 關鍵修正：使用 (year, month - 1, day) 來創建本地時間的 Date Object
                const dateParts = dateStr.split('-');
                const year = parseInt(dateParts[0]);
                const month = parseInt(dateParts[1]);
                const day = parseInt(dateParts[2]);
                const date = new Date(year, month - 1, day); 
                
                const dateKey = formatDate(date); // M/D format for exclusion check

                // 檢查排除日期清單 (M/D 格式)
                if (excludeDates.includes(dateKey)) {
                    continue; // 跳過指定的日期
                }

                const todayItems = learningItems.slice(index, index + dailyAmount);
                if (todayItems.length > 0) {
                    
                    // taskObj.text 僅包含 [Prefix] [Range]
                    if (shouldGeneratePrimaryTask) { 
                        const task = `${studyPrefix} ${getRangeString(todayItems)}`; 
                        if (!allPlans[dateStr]) allPlans[dateStr] = [];
                        allPlans[dateStr].push({text: task, planId: id});
                    }
                    
                    // Schedule Reviews based on the actual study date (date)
                    scheduleReviews(date, todayItems, allPlans, id, reviewPrefix, showReview, excludeWeekdays, excludeDates); 
                    
                    index += dailyAmount;
                }
            }
            
        } else {
            // Case 2: No Specified Execution Dates (Use sequential date generation, original logic)
            
            // Define the actual starting point for the iteration
            // 修正：使用 (year, month - 1, day) 確保日期正確
            const parts = startDateValue.split('-');
            let dateCursor = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));

            while (index < learningItems.length) {
                const dateKey = formatDate(dateCursor);
                const dateStr = getDateStr(dateCursor); // 使用已修正的 getDateStr

                if (excludeWeekdays.includes(dateCursor.getDay()) || excludeDates.includes(dateKey)) {
                    dateCursor.setDate(dateCursor.getDate() + 1);
                    continue;
                }

                const todayItems = learningItems.slice(index, index + dailyAmount);
                if (todayItems.length > 0) {
                    
                    // taskObj.text 僅包含 [Prefix] [Range]
                    if (shouldGeneratePrimaryTask) { 
                        const task = `${studyPrefix} ${getRangeString(todayItems)}`; 
                        if (!allPlans[dateStr]) allPlans[dateStr] = [];
                        allPlans[dateStr].push({text: task, planId: id});
                    }
                    
                    // Schedule Reviews based on the study date (dateCursor)
                    scheduleReviews(dateCursor, todayItems, allPlans, id, reviewPrefix, showReview, excludeWeekdays, excludeDates); 
                    
                    index += dailyAmount;
                }
                dateCursor.setDate(dateCursor.getDate() + 1);
            }
        }

      });

      latestPlan = allPlans;
      renderCalendar(allPlans);
    }

    /**
     * @description 重新設計的月曆顯示邏輯。
     */
    function renderCalendar(calendarMap) {
      const calendar = document.getElementById("calendar");
      calendar.innerHTML = "";

      const keys = Object.keys(calendarMap).sort();
      if (keys.length === 0) return;

      const getSafeDate = (dateStr) => {
          const parts = dateStr.split('-');
          // YYYY, M-1, D to avoid timezone issues
          return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
      };

      const startDate = getSafeDate(keys[0]);
      const endDate = getSafeDate(keys[keys.length - 1]);
      
      let cursor = new Date(startDate.getFullYear(), startDate.getMonth(), 1); // Start at the 1st day of the first month
      const endMonth = endDate.getMonth();
      const endYear = endDate.getFullYear();
      
      const weekdayNames = currentLang === 'zh' ? weekdayMap : weekdayMap_en;
      
      // Loop through each month from start to end
      while (cursor.getFullYear() < endYear || (cursor.getFullYear() === endYear && cursor.getMonth() <= endMonth)) {
          
          const monthId = `${cursor.getFullYear()}-${String(cursor.getMonth() + 1).padStart(2, '0')}`;
          
          const monthContainer = document.createElement('div');
          monthContainer.className = 'month-container';
          monthContainer.dataset.monthId = monthId; // Add unique ID for collapse
          
          const monthHeader = document.createElement('div');
          monthHeader.className = 'month-header';
          const monthName = currentLang === 'zh' ? `${cursor.getFullYear()} 年 ${cursor.getMonth() + 1} 月` : `${cursor.toLocaleString('default', { month: 'long' })} ${cursor.getFullYear()}`;
          
          // *** NEW: Collapse Button in Header (FIX: 展開 ▲ / 收合 ▼) ***
          const headerContent = document.createElement('div');
          headerContent.style.cssText = 'display: flex; justify-content: space-between; align-items: center; cursor: pointer;';
          // 初始為展開狀態，圖標為 ▲
          headerContent.innerHTML = `
              <span>${monthName}</span>
              <span class="toggle-icon" id="month-toggle-${monthId}">▲</span> 
          `;
          // Attach click handler to toggle collapse
          headerContent.onclick = () => toggleMonthContent(monthId); 
          monthHeader.appendChild(headerContent);
          monthContainer.appendChild(monthHeader);
          
          // *** NEW: Collapsible Content Wrapper ***
          const contentWrapper = document.createElement('div');
          contentWrapper.className = 'month-content-wrapper'; // Default is not collapsed (show content)
          contentWrapper.id = `month-content-${monthId}`;
          monthContainer.appendChild(contentWrapper);
          
          const grid = document.createElement('div');
          grid.className = 'calendar-grid';
          contentWrapper.appendChild(grid);
          
          // 1. Weekday Headers (Sun to Sat)
          for (let i = 0; i < 7; i++) {
              const header = document.createElement('div');
              header.className = 'weekday-header';
              header.textContent = weekdayNames[i];
              grid.appendChild(header);
          }
          
          // 2. Placeholder for days before the 1st
          const firstDayOfMonth = new Date(cursor.getFullYear(), cursor.getMonth(), 1);
          const startOffset = firstDayOfMonth.getDay(); // 0 (Sun) to 6 (Sat)
          
          for (let i = 0; i < startOffset; i++) {
              const emptyDiv = document.createElement('div');
              emptyDiv.className = 'empty-day';
              grid.appendChild(emptyDiv);
          }
          
          // 3. Days of the Month
          let dayCursor = new Date(firstDayOfMonth);
          
          while (dayCursor.getMonth() === firstDayOfMonth.getMonth()) {
              const dateStr = getDateStr(dayCursor); // YYYY-MM-DD (使用已修正的 getDateStr)
              
              const dayDiv = document.createElement('div');
              
              const label = document.createElement("span");
              label.className = "day-label";
              
              const dateSpan = document.createElement("span");
              // *** 修正：僅顯示日期數字 ***
              dateSpan.textContent = `${dayCursor.getDate()}`; 
              label.appendChild(dateSpan);
              
              // Add checkbox if there are tasks
              if (calendarMap[dateStr]) {
                  dayDiv.className = "day"; // 有任務才設定 .day 樣式
                  const checkbox = document.createElement("input");
                  checkbox.type = "checkbox";
                  checkbox.className = "day-checkbox";
                  checkbox.value = dateStr; 
                  label.appendChild(checkbox);
              } else {
                  dayDiv.className = "empty-day"; // 沒任務，但仍是當月日期，使用 .empty-day
                  
                  // 沒有任務時，仍然要顯示日期
                  const dayNumDiv = document.createElement('div');
                  dayNumDiv.className = "day-label";
                  dayNumDiv.appendChild(dateSpan);
                  dayDiv.appendChild(dayNumDiv);

                  // 檢查是否為當天日期 (僅做日期邊框提醒)
                  const todayStr = getDateStr(new Date());
                  if (dateStr === todayStr) {
                    dayDiv.style.border = '2px solid orange';
                  }
                  
                  grid.appendChild(dayDiv);
                  dayCursor.setDate(dayCursor.getDate() + 1);
                  continue; // 跳過任務處理
              }
              
              dayDiv.appendChild(label);
              
              // Add tasks
              if (calendarMap[dateStr]) {
                calendarMap[dateStr].forEach(taskObj => {
                  const taskDiv = document.createElement("div");
                  
                  const planTitle = document.getElementById(`unit-${taskObj.planId}`) ? document.getElementById(`unit-${taskObj.planId}`).value : `計劃 #${taskObj.planId}`;
                  
                  // taskObj.text is: "[Prefix] [Range]" (e.g., "學習 8")
                  const parts = taskObj.text.split(' ');
                  const prefix = parts[0]; // e.g., "學習"
                  // 重新組合剩餘部分作為範圍字串 (可能包含空格)
                  const range = parts.slice(1).join(' '); 

                  // *** 修正: 任務顯示格式調整為 [顯示內容] [學習內容] [學習範圍] ***
                  const taskName = `${prefix} ${planTitle} ${range}`;
                  
                  taskDiv.textContent = taskName;
                  taskDiv.className = "task";
                  taskDiv.title = taskName; // Add title for hover tooltip
                  taskDiv.style.backgroundColor = planColors[taskObj.planId] || defaultColors[(taskObj.planId - 1) % defaultColors.length];
                  dayDiv.appendChild(taskDiv);
                });
              }

              grid.appendChild(dayDiv);
              
              // Move to the next day
              dayCursor.setDate(dayCursor.getDate() + 1);
          }
          
          calendar.appendChild(monthContainer);
          
          // Move cursor to the 1st day of the next month
          cursor.setMonth(cursor.getMonth() + 1);
      }
    }
    
    /**
     * @description 控制月份內容收合的函式。(FIX: 展開 ▲ / 收合 ▼)
     * @param {string} monthId 月份 ID (YYYY-MM)。
     */
    function toggleMonthContent(monthId) {
        const content = document.getElementById(`month-content-${monthId}`);
        const icon = document.getElementById(`month-toggle-${monthId}`);
        if (content && icon) {
            content.classList.toggle('collapsed');
            
            // 修正：根據收合狀態切換圖標
            if (content.classList.contains('collapsed')) {
                // 已收合 -> 顯示向下三角形 (▼)
                icon.textContent = '▼';
            } else {
                // 已展開 -> 顯示向上三角形 (▲)
                icon.textContent = '▲';
            }
        }
    }


    /**
     * @description Helper function to format the task object into the final event title string
     */
    function formatTaskForCalendar(taskObj) {
        const planTitle = document.getElementById(`unit-${taskObj.planId}`) ? document.getElementById(`unit-${taskObj.planId}`).value : (currentLang === 'zh' ? `計劃 #${taskObj.planId}` : `Plan #${taskObj.planId}`);
        // taskObj.text is: "[Prefix] [Range]"
        const parts = taskObj.text.split(' ');
        const prefix = parts[0]; 
        const range = parts.slice(1).join(' '); 
        // 格式：[顯示內容] [學習內容] [學習範圍]
        return `${prefix} ${planTitle} ${range}`;
    }

    /**
     * @description 根據 Google Caledar Import 格式，生成 CSV 檔案。
     */
    function downloadCSV() {
      // 1. Get the selected export mode from the radio buttons
      const titleOption = document.querySelector('input[name="gcTitleOption"]:checked').value;

      // 2. Define the Google Calendar CSV header
      // Header: Subject,Start Date,Start Time,End Date,End Time,All Day Event,Description,Location
      let csv = "Subject,Start Date,Start Time,End Date,End Time,All Day Event,Description,Location\n";
      
      const rows = [];
      const keys = Object.keys(latestPlan).sort();
      
      // Separator for merged tasks (same as used for Google Calendar URL generation)
      const separator = currentLang === 'zh' ? ' ＆ ' : ' & '; 
      
      const getFormattedDate = (dateStr) => {
          // dateStr is YYYY-MM-DD
          // Google Calendar import prefers YYYY/MM/DD
          const parts = dateStr.split('-');
          return `${parts[0]}/${parts[1]}/${parts[2]}`; 
      };

      keys.forEach(dateStr => {
          const tasks = latestPlan[dateStr];
          if (!tasks || tasks.length === 0) return;

          const formattedDate = getFormattedDate(dateStr);
          const allDayEvent = 'TRUE'; // Always TRUE for all-day events
          const emptyFields = ',,'; // Start Time, End Time

          if (titleOption === 'merge') {
              // Merge Mode: One row per day
              const combinedTaskTexts = tasks.map(task => formatTaskForCalendar(task)).join(separator);
              // Use CSV escaping for the Subject (replace " with "")
              const subject = `"${combinedTaskTexts.replace(/"/g, '""')}"`;
              
              // CSV Row: Subject,Start Date,Start Time,End Date,End Time,All Day Event,Description,Location
              const row = `${subject},${formattedDate}${emptyFields}${formattedDate}${emptyFields}${allDayEvent},,`;
              rows.push(row);
              
          } else {
              // Separate Mode: One row per task
              tasks.forEach(taskObj => {
                  const subjectText = formatTaskForCalendar(taskObj);
                  // Use CSV escaping for the Subject
                  const subject = `"${subjectText.replace(/"/g, '""')}"`;

                  // CSV Row: Subject,Start Date,Start Time,End Date,End Time,All Day Event,Description,Location
                  const row = `${subject},${formattedDate}${emptyFields}${formattedDate}${emptyFields}${allDayEvent},,`;
                  rows.push(row);
              });
          }
      });
      
      csv += rows.join("\n");
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a");
      link.setAttribute("href", URL.createObjectURL(blob));
      link.setAttribute("download", "google_calendar_import.csv");
      link.click();
    }
    
    // *** Added: 全選日期功能 ***
    function toggleAllCheckboxes() {
      const selectAll = document.getElementById('selectAllDays').checked;
      document.querySelectorAll('.day-checkbox').forEach(checkbox => {
        checkbox.checked = selectAll;
      });
    }

    // Helper function to create the Google Calendar URL for a single event
    function createCalendarUrl(dateStr, eventTitle) {
        // Format date for Google Calendar: YYYYMMDD
        const formatGCDate = (dStr) => dStr.replace(/-/g, '');
        
        // For All-Day event, the date range is StartDay/EndDay+1
        const startDateGC = formatGCDate(dateStr);
        
        // Calculate End Date + 1
        const dateParts = dateStr.split('-');
        const year = parseInt(dateParts[0]);
        const month = parseInt(dateParts[1]);
        const day = parseInt(dateParts[2]);
        const safeDate = new Date(year, month - 1, day);
        safeDate.setDate(safeDate.getDate() + 1);
        
        const endDateStr = getDateStr(safeDate); // YYYY-MM-DD
        const endDateGC = formatGCDate(endDateStr);
        
        const datesParam = `${startDateGC}/${endDateGC}`;
        
        const baseUrl = 'https://www.google.com/calendar/render?action=TEMPLATE';
        const params = new URLSearchParams({
            text: eventTitle,
            details: '', // Description 留空
            dates: datesParam,
            sf: 'true',
            output: 'xml'
        });

        return `${baseUrl}&${params.toString()}`;
    }

    // *** 加入 Google 行事曆 按鈕功能 ***
    function addToGoogleCalendar() {
      const selectedDates = [];
      document.querySelectorAll('.day-checkbox:checked').forEach(checkbox => {
        selectedDates.push(checkbox.value); // YYYY-MM-DD
      });

      if (selectedDates.length === 0) {
        alert(currentLang === 'zh' ? '請先在計劃表上勾選要匯入行事曆的日期。' : 'Please select the dates on the plan you want to import to the calendar.');
        return;
      }
      
      const titleOption = document.querySelector('input[name="gcTitleOption"]:checked').value;
      let eventsToOpen = [];
      
      selectedDates.forEach((dateStr) => {
        const tasks = latestPlan[dateStr];
        
        if (tasks && tasks.length > 0) {
          if (titleOption === 'merge') {
            // A. 合併多個計劃 (Merged Mode)
            
            // 關鍵修正: 合併當日所有任務文本
            const separator = currentLang === 'zh' ? ' ＆ ' : ' & ';
            const combinedTaskTexts = tasks.map(task => formatTaskForCalendar(task)).join(separator);
            
            const eventTitle = combinedTaskTexts; 
            const url = createCalendarUrl(dateStr, eventTitle);
            eventsToOpen.push(url);
            
          } else if (titleOption === 'separate') {
            // B. 將各計劃獨立顯示 (Separate Mode)
            
            tasks.forEach(task => {
                const eventTitle = formatTaskForCalendar(task);
                const url = createCalendarUrl(dateStr, eventTitle);
                eventsToOpen.push(url);
            });
          }
        }
      });
      
      // B-4. 安全 Alert 視窗確認 (僅在獨立顯示模式下，且事件數超過 10 個時觸發)
      if (titleOption === 'separate' && eventsToOpen.length > 10) {
          const confirmationMessage = currentLang === 'zh' 
              ? `您已選擇將各計劃獨立顯示，這將會開啟 ${eventsToOpen.length} 個 Google 行事曆視窗。是否確認執行？`
              : `You have chosen to show each plan separately, which will open ${eventsToOpen.length} Google Calendar windows. Do you want to proceed?`;
              
          if (!confirm(confirmationMessage)) {
              return; // 使用者取消，則停止執行
          }
      }

      // Open all generated URLs
      if (eventsToOpen.length > 0) {
        eventsToOpen.forEach((url, index) => {
            // 使用獨特的目標名稱 (target name) 來幫助瀏覽器識別為獨立的分頁
            window.open(url, 'gc_event_day_' + index); 
        });
      }
    }


    function updatePlanTitle(id, content) {
        const headerH3 = document.getElementById(`header-h3-${id}`);
        const planHeader = translations[currentLang].planHeader;
        if (headerH3) {
            // content 來自 unit input value
            headerH3.textContent = `${planHeader} #${id}${content ? ' ' + content : ''}`;
        }
    }

    function randomizeColor(id) {
        const colorPicker = document.getElementById(`colorPicker-${id}`);
        const planGroup = document.querySelector(`.plan-group[data-id="${id}"]`);
        
        const randomIndex = Math.floor(Math.random() * randomPalette.length);
        const newColor = randomPalette[randomIndex];
        
        colorPicker.value = newColor;
        planGroup.style.backgroundColor = newColor;
    }
    
    // *** Function: 顯示/隱藏自訂文字輸入框 ***
    function toggleCustomText(id) {
        const customDiv = document.getElementById(`customTextDiv-${id}`);
        const checkbox = document.getElementById(`showCustom-${id}`);
        if (customDiv) {
            customDiv.style.display = checkbox.checked ? 'block' : 'none';
        }
    }


    function addPlan(planData = null) {
      planCount++;
      const id = planCount;
      const container = document.getElementById('plan-container');
      const newPlanGroup = document.createElement('div');
      newPlanGroup.className = 'plan-group';
      newPlanGroup.dataset.id = id;

      const colorValue = planData ? planData.color : defaultColors[(id - 1) % defaultColors.length];
      const excludedDays = planData && planData.excludeWeekdays ? planData.excludeWeekdays : [];
      
      const showStudy = planData && planData.showStudy !== undefined ? planData.showStudy : true;
      const showReview = planData && planData.showReview !== undefined ? planData.showReview : true;
      const showCustom = planData && planData.showCustom !== undefined ? planData.showCustom : false;
      const customText = planData && planData.customText ? planData.customText : '';
      const executionDates = planData && planData.executionDates ? planData.executionDates : '';
      const excludeDates = planData && planData.excludeDates ? planData.excludeDates : ''; 
      
      const initialUnitValue = planData ? planData.unit : ''; 
      const planHeader = translations[currentLang].planHeader;

      newPlanGroup.style.backgroundColor = colorValue;

      newPlanGroup.innerHTML = `
        <div class="plan-header" id="plan-header-${id}">
          <div style="display: flex; align-items: center;">
            <h3 id="header-h3-${id}" placeholder="111">${planHeader} #${id}${initialUnitValue ? ' ' + initialUnitValue : ''}</h3>
          </div>
          <div class="btn-group">
            <span class="toggle-icon" id="toggle-icon-${id}">▲</span> <button class="delete-btn" onclick="deletePlan(${id})" data-i18n-id="deleteBtn">${translations[currentLang].deleteBtn}</button>
          </div>
        </div>
        <div id="plan-content-${id}" class="plan-content">
          <label class="color-label">
            <span data-i18n-id="colorLabel">${translations[currentLang].colorLabel}</span>
            <input type="color" id="colorPicker-${id}" value="${colorValue}">
            <button onclick="randomizeColor(${id})" type="button" data-i18n-id="randomColorBtn">${translations[currentLang].randomColorBtn}</button>
          </label>
          
          <label><span data-i18n-id="unitLabel">${translations[currentLang].unitLabel}</span><input id="unit-${id}" type="text" value="${planData ? planData.unit : ''}"></label>
          <label><span data-i18n-id="startDateLabel">${translations[currentLang].startDateLabel}</span><input id="startDate-${id}" type="date" value="${planData ? planData.startDate : ''}"></label>
          <label><span data-i18n-id="endDateLabel">${translations[currentLang].endDateLabel}</span><input id="endDate-${id}" type="date" value="${planData ? planData.endDate : ''}"></label>
          
          <label><span data-i18n-id="executionDatesLabel">${translations[currentLang].executionDatesLabel}</span><textarea id="executionDates-${id}" data-i18n-placeholder="executionDatesPlaceholder" placeholder="${translations[currentLang].executionDatesPlaceholder}">${executionDates}</textarea></label>

          <label data-i18n-id="excludeDaysLabel">${translations[currentLang].excludeDaysLabel}</label>
          <div class="weekday-checkboxes">
            <label><input id="excludeWeekday-${id}-0" type="checkbox" ${excludedDays.includes(0) ? 'checked' : ''}><span data-i18n-id="weekdaySun"> ${translations[currentLang].weekdaySun}</span></label>
            <label><input id="excludeWeekday-${id}-1" type="checkbox" ${excludedDays.includes(1) ? 'checked' : ''}><span data-i18n-id="weekdayMon"> ${translations[currentLang].weekdayMon}</span></label>
            <label><input id="excludeWeekday-${id}-2" type="checkbox" ${excludedDays.includes(2) ? 'checked' : ''}><span data-i18n-id="weekdayTue"> ${translations[currentLang].weekdayTue}</span></label>
            <label><input id="excludeWeekday-${id}-3" type="checkbox" ${excludedDays.includes(3) ? 'checked' : ''}><span data-i18n-id="weekdayWed"> ${translations[currentLang].weekdayWed}</span></label>
            <label><input id="excludeWeekday-${id}-4" type="checkbox" ${excludedDays.includes(4) ? 'checked' : ''}><span data-i18n-id="weekdayThu"> ${translations[currentLang].weekdayThu}</span></label>
            <label><input id="excludeWeekday-${id}-5" type="checkbox" ${excludedDays.includes(5) ? 'checked' : ''}><span data-i18n-id="weekdayFri"> ${translations[currentLang].weekdayFri}</span></label>
            <label><input id="excludeWeekday-${id}-6" type="checkbox" ${excludedDays.includes(6) ? 'checked' : ''}><span data-i18n-id="weekdaySat"> ${translations[currentLang].weekdaySat}</span></label>
          </div>
          
          <label><span data-i18n-id="excludeDatesLabel">${translations[currentLang].excludeDatesLabel}</span><textarea id="excludeDates-${id}" data-i18n-placeholder="excludeDatesPlaceholder" placeholder="${translations[currentLang].excludeDatesPlaceholder}">${excludeDates}</textarea></label>
          
          <label data-i18n-id="rangeLabel">${translations[currentLang].rangeLabel}</label>
          <div style="margin-bottom: 8px;">
            <input type="radio" id="rangeTypePages-${id}" name="rangeType-${id}" value="pages" ${planData && planData.rangeType === 'outline' ? '' : 'checked'} onchange="toggleRangeInput(${id})">
            <label for="rangeTypePages-${id}" style="display: inline;" data-i18n-id="rangeTypePages">${translations[currentLang].rangeTypePages}</label>
            <input type="radio" id="rangeTypeOutline-${id}" name="rangeType-${id}" value="outline" ${planData && planData.rangeType === 'outline' ? 'checked' : ''} onchange="toggleRangeInput(${id})">
            <label for="rangeTypeOutline-${id}" style="display: inline;" data-i18n-id="rangeTypeOutline">${translations[currentLang].rangeTypeOutline}</label>
          </div>
          <div id="pageRangeDiv-${id}" style="display: ${planData && planData.rangeType === 'outline' ? 'none' : 'block'};">
            <label><span data-i18n-id="pageRangeLabel">${translations[currentLang].pageRangeLabel}</span><input id="pageRange-${id}" type="text" value="${planData ? planData.pageRange : ''}"></label>
          </div>
          <div id="outlineDiv-${id}" style="display: ${planData && planData.rangeType === 'outline' ? 'block' : 'none'};">
            <label><span data-i18n-id="outlineLabel">${translations[currentLang].outlineLabel}</span><textarea id="outline-${id}" data-i18n-placeholder="outlinePlaceholder" placeholder="${translations[currentLang].outlinePlaceholder}">${planData ? planData.outline : ''}</textarea></label>
          </div>
          
          <label><span data-i18n-id="dailyAmountLabel">${translations[currentLang].dailyAmountLabel}</span><input id="dailyAmount-${id}" type="number" min="1" value="${planData ? planData.dailyAmount : ''}"></label>
          
          <label><input id="reverseOrder-${id}" type="checkbox" ${planData && planData.reverseOrder ? 'checked' : ''}><span data-i18n-id="reverseOrder"> ${translations[currentLang].reverseOrder}</span></label>
          
          <label data-i18n-id="showContentLabel">${translations[currentLang].showContentLabel}</label>
          <div>
            <label style="display: inline-block; margin-right: 15px;"><input id="showStudy-${id}" type="checkbox" ${showStudy ? 'checked' : ''}><span data-i18n-id="showStudy"> ${translations[currentLang].showStudy}</span></label>
            <label style="display: inline-block; margin-right: 15px;"><input id="showReview-${id}" type="checkbox" ${showReview ? 'checked' : ''}><span data-i18n-id="showReview"> ${translations[currentLang].reviewText}</span></label>
            <label style="display: inline-block;"><input id="showCustom-${id}" type="checkbox" ${showCustom ? 'checked' : ''} onchange="toggleCustomText(${id})"><span data-i18n-id="showCustom"> ${translations[currentLang].showCustom}</span></label>
          </div>
          <div id="customTextDiv-${id}" style="display: ${showCustom ? 'block' : 'none'};">
            <label><span data-i18n-id="customTextLabel">${translations[currentLang].customTextLabel}</span>
            <input id="customText-${id}" type="text" data-i18n-placeholder="customTextPlaceholder" placeholder="${translations[currentLang].customTextPlaceholder}" value="${customText}"></label>
          </div>
        </div>
      `;
      container.appendChild(newPlanGroup);

      // 實時更新標題功能：改為監聽 Unit 欄位
      const unitInput = document.getElementById(`unit-${id}`);
      unitInput.addEventListener('input', (event) => {
          updatePlanTitle(id, event.target.value);
      });

      // 顏色選擇器功能
      const colorPicker = document.getElementById(`colorPicker-${id}`);
      colorPicker.addEventListener('input', (event) => {
        newPlanGroup.style.backgroundColor = event.target.value;
      });

      // 收合功能 (FIXED: 點擊事件監聽 Plan Header)
      const header = newPlanGroup.querySelector('.plan-header');
      header.addEventListener('click', (event) => {
          // 確保點擊的不是刪除按鈕
          if (!event.target.classList.contains('delete-btn') && !event.target.closest('.delete-btn')) {
              togglePlanContent(id);
          }
      });
    }
    
    function toggleRangeInput(id) {
      const rangeType = document.querySelector(`input[name="rangeType-${id}"]:checked`).value;
      document.getElementById(`pageRangeDiv-${id}`).style.display = rangeType === 'pages' ? 'block' : 'none';
      document.getElementById(`outlineDiv-${id}`).style.display = rangeType === 'outline' ? 'block' : 'none';
    }

    /**
     * @description 控制計劃內容收合的函式。(FIX: 展開 ▲ / 收合 ▼)
     * @param {number} id 計劃 ID。
     */
    function togglePlanContent(id) {
      const content = document.getElementById(`plan-content-${id}`);
      const icon = document.getElementById(`toggle-icon-${id}`);
      if (content && icon) {
          content.classList.toggle('collapsed');
          
          // 修正：根據收合狀態切換圖標
          if (content.classList.contains('collapsed')) {
              // 已收合 -> 顯示向下三角形 (▼)
              icon.textContent = '▼';
          } else {
              // 已展開 -> 顯示向上三角形 (▲)
              icon.textContent = '▲';
          }
      }
    }

    function deletePlan(id) {
      const planGroup = document.querySelector(`.plan-group[data-id="${id}"]`);
      if (planGroup) {
        planGroup.remove();
        delete planColors[id];
      }
    }

    // --- 國際化/語言切換邏輯 ---
    function setLanguage(lang) {
      currentLang = lang;
      document.documentElement.lang = lang; // 設定 html 標籤的 lang 屬性

      // 1. 更新所有 data-i18n 屬性的元素 (用於 Header/Title 等)
      document.querySelectorAll('[data-i18n]').forEach(element => {
          const key = element.getAttribute('data-i18n');
          if (translations[lang][key]) {
              element.textContent = translations[lang][key];
          }
      });

      // 2. 更新所有 data-i18n-id 屬性的元素 (用於 Label/Button/Span 等)
      document.querySelectorAll('[data-i18n-id]').forEach(element => {
          const key = element.getAttribute('data-i18n-id');
          const translation = translations[lang][key];
          if (translation) {
              // 針對 checkbox/radio 的標籤文本 (已經用 span 包裹)
              if (element.tagName === 'SPAN' && element.closest('.weekday-checkboxes, .plan-content div, #addToCalendarBtn, .sidebar label')) {
                 element.textContent = ` ${translation}`; // 保留一個空格與前面的 checkbox/icon 分開
              } 
              else {
                 element.textContent = translation; // 其他純文本元素
              }
          }
      });
      
      // 3. 更新所有 placeholder 屬性 (用於 Input/Textarea)
      document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
          const key = element.getAttribute('data-i18n-placeholder');
          if (translations[lang][key]) {
              element.placeholder = translations[lang][key];
          }
      });

      // 4. 針對計劃標題做特別處理 (因為它包含 ID 和使用者輸入)
      document.querySelectorAll('.plan-group').forEach(group => {
        const id = group.dataset.id;
        // *** 調整：標題更新改為抓取 unit 的值 ***
        const unit = document.getElementById(`unit-${id}`) ? document.getElementById(`unit-${id}`).value : '';
        updatePlanTitle(id, unit); 
      });

      // ************* 針對圖標按鈕的新增邏輯 *************

      // 5. 更新語言切換按鈕內容 (保留 icon + 顯示語言縮寫)
      const langBtn = document.getElementById('lang-toggle-btn');
      if (langBtn) {
        const langAbbrText = lang === 'zh' ? 'EN' : 'CH';
        // 使用 innerHTML 確保 Font Awesome 圖標 <i class="fa-solid fa-language"></i> 永遠存在
        langBtn.innerHTML = `<i class="fa-solid fa-language"></i> ${langAbbrText}`;
      }
      
      // 6. 重新設定主題切換按鈕圖標和文本
      const themeIcon = document.getElementById('theme-icon');
      const themeTextSpan = document.getElementById('theme-toggle-btn') ? document.getElementById('theme-toggle-btn').querySelector('[data-i18n-id="toggleThemeBtn"]') : null;

      if (themeIcon && themeTextSpan) {
          const isDarkMode = document.body.classList.contains('dark-mode');
          
          // 更新 Icon
          if (isDarkMode) {
              themeIcon.classList.remove('fa-moon');
              themeIcon.classList.add('fa-sun');
              // 更新文本
              themeTextSpan.textContent = lang === 'zh' ? '日間模式' : 'Light';
          } else {
              themeIcon.classList.remove('fa-sun');
              themeIcon.classList.add('fa-moon');
              // 更新文本
              themeTextSpan.textContent = lang === 'zh' ? '夜間模式' : 'Dark';
          }
      }

      // ************* 針對圖標按鈕的新增邏輯 End *************


      // 7. 重新生成行事曆以更新學習/複習文本 (如果已生成)
      if (Object.keys(latestPlan).length > 0) {
          generatePlan(); // 重新生成會調用 renderCalendar
      }
    }

    function toggleLanguage() {
      const newLang = currentLang === 'zh' ? 'en' : 'zh';
      setLanguage(newLang);
      localStorage.setItem('lang', newLang);
    }

    function loadLanguage() {
      const savedLang = localStorage.getItem('lang') || 'zh';
      setLanguage(savedLang);
    }
    // --- END 國際化/語言切換邏輯 ---


    // Dark/Light Mode 邏輯
    function toggleTheme() {
        const body = document.body;
        const button = document.getElementById('theme-toggle-btn');
        const themeIcon = document.getElementById('theme-icon'); 
        const themeTextSpan = button.querySelector('[data-i18n-id="toggleThemeBtn"]');

        body.classList.toggle('dark-mode');
        
        const isDarkMode = body.classList.contains('dark-mode');

        localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');

        if (isDarkMode) {
            // 切換為 Dark Mode (顯示切換回 Light Mode 的選項)
            themeIcon.classList.remove('fa-moon');
            themeIcon.classList.add('fa-sun');
            themeTextSpan.textContent = currentLang === 'zh' ? '日間模式' : 'Light';
        } else {
            // 切換為 Light Mode (顯示切換到 Dark Mode 的選項)
            themeIcon.classList.remove('fa-sun');
            themeIcon.classList.add('fa-moon');
            themeTextSpan.textContent = currentLang === 'zh' ? '夜間模式' : 'Dark';
        }
    }

    function loadTheme() {
        // 從 localStorage 讀取主題，預設為 light
        const savedTheme = localStorage.getItem('theme') || 'light';
        const body = document.body;
        const button = document.getElementById('theme-toggle-btn');
        const themeIcon = document.getElementById('theme-icon'); 
        const themeTextSpan = button ? button.querySelector('[data-i18n-id="toggleThemeBtn"]') : null;
        
        if (savedTheme === 'dark') {
            body.classList.add('dark-mode');
            if(themeIcon) {
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
            }
            if(themeTextSpan) themeTextSpan.textContent = currentLang === 'zh' ? '日間模式' : 'Light';
        } else {
            body.classList.remove('dark-mode');
            if(themeIcon) {
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
            }
            if(themeTextSpan) themeTextSpan.textContent = currentLang === 'zh' ? '夜間模式' : 'Dark';
        }
    }

    // Initialize with one plan and load theme and language
    loadLanguage();
    loadTheme();
    // 首次載入時，先確保語言已設定，再新增計劃，這樣計劃內的文本才會是正確語言
    if (planCount === 0) {
      addPlan();
    }
  </script>
</body>
</html>